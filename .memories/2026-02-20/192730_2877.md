---
id: checkpoint_28779b40
timestamp: 2026-02-20T19:27:30.514Z
tags:
  - eros
  - code-model
  - CodeRankEmbed
  - embeddings
git:
  branch: main
  commit: e2b59d0
  files:
    - .julie/.gitignore
    - .memories/2026-02-20/190733_8b49.md
    - .memories/2026-02-20/191255_8b60.md
    - .memories/2026-02-20/191552_d249.md
    - .memories/2026-02-20/191956_b10a.md
    - CLAUDE.md
    - EROS_AGENT_INSTRUCTIONS.md
    - pyproject.toml
    - python/eros/chunking.py
    - python/eros/config.py
    - python/eros/embeddings.py
    - python/eros/retrieval.py
    - python/eros/server.py
    - python/tests/test_chunking.py
    - uv.lock
summary: "## Swapped code model from broken Jina v2 to CodeRankEmbed"
---

## Swapped code model from broken Jina v2 to CodeRankEmbed

### What
Replaced `jinaai/jina-embeddings-v2-base-code` with `nomic-ai/CodeRankEmbed` as the default code embedding model.

### Why
Jina v2 was **silently failing** — its custom BERT code imports `find_pruneable_heads_and_indices` which was removed in `transformers 5.x`. The silent `except Exception` fallback degraded both models to `bge-small-en-v1.5`, defeating the entire dual-model architecture. Jina v3 has the same class of compatibility issue (`all_tied_weights_keys` renamed).

### How
- **`config.py`**: Default code model → `nomic-ai/CodeRankEmbed`
- **`embeddings.py`**: Removed silent fallback, always pass `trust_remote_code=True`
- **`pyproject.toml`**: Added `einops` dependency (required by CodeRankEmbed)
- **`CLAUDE.md`**: Updated config table

### Quality comparison (same query: "function that validates user input")
- **CodeRankEmbed**: 0.63 (relevant) vs 0.08 (irrelevant) = **8x separation**
- **bge-small**: 0.80 vs 0.55 = **1.5x separation**
- CodeRankEmbed is far more discriminating for code search

### Impact
- 55/55 tests passing
- Server restart + index rebuild needed for live testing
