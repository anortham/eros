---
id: checkpoint_438d4496
timestamp: 2026-02-25T02:34:40.995Z
tags:
  - eros
  - performance
  - self-tuning
  - persistence
  - batching
git:
  branch: main
  commit: ca188f4
  files:
    - .memories/2026-02-25/021020_01aa.md
    - .memories/2026-02-25/021910_f71c.md
    - .memories/2026-02-25/022207_4152.md
    - .memories/2026-02-25/022601_ce2f.md
    - python/eros/config.py
    - python/eros/embeddings.py
    - python/eros/incremental.py
    - python/eros/indexing.py
    - python/eros/julie_reader.py
    - python/eros/retrieval.py
    - python/eros/storage.py
    - python/tests/test_embeddings.py
    - python/tests/test_julie_reader.py
    - python/tests/test_retrieval.py
summary: "## Added persistent, bucketed self-tuning for embedding batch sizes"
planId: add-file-logging-timing-instrumentation-to-eros
type: checkpoint
confidence: 5
---

## Added persistent, bucketed self-tuning for embedding batch sizes

- **WHAT:** Implemented persistence for runtime batch tuning and split tuning state by model scope + average text length bucket.
- **WHY:** User requested both:
  1) carry tuned values across restarts,
  2) avoid one-size-fits-all tuning by separating short vs long content behavior.
- **HOW:**
  - Added `ErosConfig.batch_tuning_path` in `python/eros/config.py`.
  - Extended `DualEmbeddingManager` in `python/eros/embeddings.py` with:
    - JSON load/save for tuning state (`_load_batch_tuning`, `_save_batch_tuning`)
    - bucket logic (`tiny`, `small`, `medium`, `large`) from average text length
    - per-key state (`{scope}:{bucket}`), e.g. `code:small`, `docs:medium`
    - tuning update writes persisted state after OOM backoff and throughput-driven adjustments
  - Kept OOM backoff + growth/backoff heuristics, now bucket-specific.
  - Updated indexing call sites in `python/eros/indexing.py` to pass `avg_text_len` into `index_batch_size()`.

### Tests added/updated
- `python/tests/test_embeddings.py`
  - persistent tuning across manager restart
  - bucket-specific state isolation
  - existing self-tuning OOM/growth tests updated to use temp `eros_data_dir`
- `python/tests/test_retrieval.py`
  - fake embeddings updated for new `index_batch_size(..., avg_text_len=...)` signature

### Verification
- `uv run pytest -q --tb=short python/tests/test_embeddings.py` → passed
- `uv run pytest -q --tb=short python/tests/test_retrieval.py` → passed
- `uv run pytest -q --tb=short python/tests/` → **107 passed**
- `uv run ruff check python/eros python/tests` → passed

### Impact
- Tuning survives restarts and quickly converges per workload type.
- Short code snippets and long doc chunks no longer fight over one shared batch setting.

